FROM ubuntu:22.04

# タイムゾーンの設定（非対話的に）
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y tzdata && \
    ln -fs /usr/share/zoneinfo/Asia/Tokyo /etc/localtime && \
    dpkg-reconfigure --frontend noninteractive tzdata

# 必要最小限のパッケージをインストール
RUN apt-get update && apt-get install -y \
    curl \
    git \
    sudo \
    && rm -rf /var/lib/apt/lists/*

# テストユーザーの作成
RUN useradd -m -s /bin/bash testuser && \
    echo "testuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# テストスクリプトをコピー
COPY install.sh /tmp/install.sh
RUN chmod +x /tmp/install.sh

# テストの実行
USER testuser
WORKDIR /home/testuser

# Git 設定（chezmoi init で必要）
RUN git config --global user.email "test@example.com" && \
    git config --global user.name "Test User"

# 非対話モードでインストールスクリプトを実行
RUN NO_INTERACTIVE=1 bash /tmp/install.sh

# インストール結果の確認
RUN export PATH="$HOME/.local/bin:$PATH" && command -v chezmoi || (echo "chezmoi not found" && exit 1)
RUN command -v gh || (echo "gh not found" && exit 1)
RUN export PATH="$HOME/.local/bin:$PATH" && command -v ghq || (echo "ghq not found" && exit 1)
RUN test -f ~/.local/share/mkwork/mkwork.sh || (echo "mkwork not found" && exit 1)
RUN test -f ~/.env || (echo ".env not found" && exit 1)

CMD ["/bin/bash"]
