#!/bin/bash

# code-review プラグインの閾値変更パッチを適用するスクリプト
# このスクリプトは chezmoi apply 時に一度だけ実行される

set -e

PATCH_FILE="$HOME/.claude/patches/code-review-threshold.patch"
TARGET_FILE="$HOME/.claude/plugins/marketplaces/claude-plugins-official/plugins/code-review/commands/code-review.md"

echo "code-review プラグインの閾値変更パッチを適用中..."

# パッチファイルの存在確認
if [ ! -f "$PATCH_FILE" ]; then
    echo "⚠️  パッチファイルが見つかりません: $PATCH_FILE"
    exit 0
fi

# 対象ファイルの存在確認
if [ ! -f "$TARGET_FILE" ]; then
    echo "⚠️  対象ファイルが見つかりません: $TARGET_FILE"
    echo "   code-review プラグインがインストールされていない可能性があります"
    exit 0
fi

# パッチが既に適用されているか確認
if grep -q "Filter out any issues with a score less than 50" "$TARGET_FILE"; then
    echo "✓ パッチは既に適用されています"
    exit 0
fi

# パッチを適用
cd "$(dirname "$TARGET_FILE")"
if patch -p1 < "$PATCH_FILE"; then
    echo "✓ パッチを適用しました (閾値: 80 → 50)"
else
    echo "❌ パッチの適用に失敗しました"
    echo "   プラグインのバージョンが変更されている可能性があります"
    exit 1
fi
